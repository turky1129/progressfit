<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1320" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <title>ProgressFit</title>

  <!-- iOS Home icon -->
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png" />

  <link rel="manifest" href="/manifest.webmanifest" />

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1320;
      --panel:rgba(255,255,255,.03);
      --panel2:rgba(255,255,255,.05);
      --text:#e8eef7;
      --muted:rgba(232,238,247,.65);
      --border:rgba(255,255,255,.07);

      --good:#3eea86;
      --bad:#ff6a7a;
      --accent:#6ad8ff;

      --radius:18px;
      --radius2:22px;
    }

    html,body{height:100%;}
    body{
      margin:0;
      background: radial-gradient(1000px 700px at 20% 0%, rgba(106,216,255,.14), transparent 55%),
                  radial-gradient(800px 600px at 80% 20%, rgba(62,234,134,.08), transparent 60%),
                  linear-gradient(180deg, #0a1220, #08101a 70%);
      color:var(--text);
      font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", "Hiragino Sans", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      -webkit-font-smoothing: antialiased;
      overflow:hidden;
    }

    /* safe area */
    .safeTop{height: env(safe-area-inset-top);}
    .safeBottom{height: env(safe-area-inset-bottom);}

    .app{
      height:100%;
      display:flex;
      flex-direction:column;
    }

    .wrap{
      flex:1;
      min-height:0;
      padding:14px 14px 0;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .topRow{
      display:flex;
      align-items:center;
      gap:12px;
    }

    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, rgba(106,216,255,.25), rgba(255,255,255,.03));
      border:1px solid var(--border);
      box-shadow:0 8px 18px rgba(0,0,0,.25);
      flex:0 0 auto;
    }

    .titleBox{
      flex:1;
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .title{
      font-size:22px;
      font-weight:800;
      letter-spacing:.2px;
      line-height:1.05;
    }
    .sub{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .chips{
      display:flex;
      gap:10px;
      flex:0 0 auto;
    }
    .chip{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      padding:10px 14px;
      border-radius:999px;
      font-size:12px;
      font-weight:800;
      color:var(--text);
      cursor:pointer;
      user-select:none;
    }

    .panel{
      border:1px solid var(--border);
      background: rgba(255,255,255,.02);
      border-radius: var(--radius2);
      padding:12px;
      box-shadow: 0 14px 28px rgba(0,0,0,.25);
    }

    .periodRow{
      display:flex;
      gap:10px;
    }
    .seg{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: 999px;
      padding:6px;
      display:flex;
      gap:6px;
      flex:1;
    }
    .seg button{
      border:0;
      outline:none;
      background:transparent;
      color:var(--muted);
      font-weight:900;
      font-size:14px;
      padding:10px 12px;
      border-radius: 999px;
      flex:1;
      cursor:pointer;
      line-height:1;
      user-select:none;
    }
    .seg button.active{
      background: rgba(106,216,255,.14);
      color:var(--text);
      border: 1px solid rgba(106,216,255,.28);
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }

    .card{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: var(--radius2);
      padding:14px;
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
    }

    .cardTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
    }
    .label{
      color:var(--muted);
      font-size:13px;
      font-weight:800;
    }
    .delta{
      font-size:14px;
      font-weight:900;
    }
    .delta.good{color:var(--good);}
    .delta.bad{color:var(--bad);}

    .big{
      display:flex;
      align-items:baseline;
      gap:8px;
      font-size:36px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .unit{
      font-size:16px;
      color:var(--muted);
      font-weight:800;
    }

    .gridSmall{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .smallVal{
      font-size:26px;
      font-weight:900;
      display:flex;
      align-items:baseline;
      gap:8px;
    }
    .smallUnit{
      font-size:14px;color:var(--muted);font-weight:800;
    }

    .tabs{
      display:flex;
      gap:8px;
      margin-top:10px;
      margin-bottom:8px;
    }
    .tab{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      border-radius:999px;
      padding:10px 12px;
      font-weight:900;
      font-size:13px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      background: rgba(106,216,255,.14);
      border-color: rgba(106,216,255,.28);
      color:var(--text);
    }

    .chartBox{
      border:1px solid var(--border);
      background: rgba(255,255,255,.02);
      border-radius: var(--radius2);
      padding:12px;
      overflow:hidden;
    }
    canvas{display:block; width:100%; height:280px;}

    .view{
      flex:1;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:12px;
      overflow:hidden;
    }

    #trendView{
      flex:1;
      min-height:0;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    #bodyMapView{
      flex:1;
      min-height:0;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    #moreView{
      flex:1;
      min-height:0;
      overflow:auto;
      display:flex;
      flex-direction:column;
    }

    .moreGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .moreTools{
      margin-top:auto;
      display:flex;
      gap:10px;
      padding:12px 0 4px;
    }
    .moreTools .btn{
      flex:1;
      justify-content:center;
    }

    .mCard{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: var(--radius2);
      padding:14px;
    }
    .mTitle{
      font-size:13px;
      font-weight:900;
      color:var(--muted);
      margin-bottom:6px;
    }
    .mVal{
      font-size:28px;
      font-weight:900;
    }
    .mUnit{
      font-size:14px;
      color:var(--muted);
      font-weight:800;
      margin-left:6px;
    }

    /* buttons */
    .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color:var(--text);
      border-radius: 999px;
      padding:10px 12px;
      font-size:16px;
      font-weight:900;
      cursor:pointer;
      line-height:1;
      user-select:none;
      -webkit-appearance:none;
      appearance:none;
    }
    .btnPrimary{
      background: rgba(106,227,255,.14);
      border-color: rgba(106,227,255,.30);
    }
    .btnDanger{
      background: rgba(255,106,122,.12);
      border-color: rgba(255,106,122,.25);
    }

    .listRow{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius:12px;
      padding:10px;
      margin-bottom:8px;
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .listMain{font-size:13px; line-height:1.4;}
    .listMain b{font-weight:900;}
    .listSub{font-size:12px; color:var(--muted);}
    .listRight{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:4px;
      min-width:84px;
    }
    .pill{
      font-size:12px;
      font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color:var(--text);
      cursor:pointer;
      user-select:none;
      line-height:1;
    }

    /* modal */
    .modalBg{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:100;
    }
    .modal{
      width:min(520px, 100%);
      border:1px solid var(--border);
      background: rgba(15,24,38,.92);
      backdrop-filter: blur(10px);
      border-radius: 22px;
      padding:14px;
      box-shadow: 0 18px 40px rgba(0,0,0,.45);
    }
    .modal .mTitle{
      font-size:16px;
      color:var(--text);
      margin:4px 0 10px;
    }
    .form{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .field label{
      font-size:12px;
      color:var(--muted);
      font-weight:800;
    }
    .field input{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color:var(--text);
      border-radius: 14px;
      padding:10px 12px;
      font-size:16px;
      outline:none;
    }
    .modalActions{
      display:flex;
      gap:10px;
      margin-top:12px;
    }

    /* bottom nav */
    .viewSeg{
      margin: 10px 14px 0;
      flex:0 0 auto;
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
    }

    @media (max-width: 420px){
      canvas{height:260px;}
      .big{font-size:34px;}
    }
  </style>
</head>

<body>
<div class="app">
  <div class="safeTop"></div>

  <div class="wrap">
    <div class="topRow">
      <div class="logo"></div>

      <div class="titleBox">
        <div class="title">ProgressFit</div>
        <div class="sub" id="rangeLabel">—</div>
      </div>

      <div class="chips">
        <div class="chip" id="countChip">件数 0</div>
        <div class="chip" id="targetChip">目標</div>
        <div class="chip" id="addChip">+データ</div>
      </div>
    </div>

    <div class="panel">
      <div class="periodRow">
        <div class="seg" id="periodSeg">
          <button class="active" data-period="all">全期間</button>
          <button data-period="1y">1年</button>
          <button data-period="3m">3ヶ月</button>
        </div>
      </div>
    </div>

    <div class="view">
      <!-- Trend -->
      <div id="trendView">
        <div class="grid2" id="topCards"></div>

        <div class="gridSmall" id="midCards"></div>

        <div class="tabs" id="metricTabs">
          <div class="tab active" data-metric="weight_kg">体重</div>
          <div class="tab" data-metric="bodyfat_pct">体脂肪率</div>
          <div class="tab" data-metric="fatmass_kg">体脂肪量</div>
          <div class="tab" data-metric="muscle_kg">筋肉量</div>
        </div>

        <div class="chartBox">
          <canvas id="chart"></canvas>
        </div>
      </div>

      <!-- BodyMap -->
      <div id="bodyMapView" style="display:none;">
        <div class="panel">
          <div style="font-weight:900; color:var(--muted); margin-bottom:8px;">BodyMap</div>
          <div style="color:var(--muted); font-size:13px;">（ここは後で拡張枠）</div>
        </div>
      </div>

      <!-- More -->
      <div id="moreView" style="display:none;">
        <div class="moreGrid" id="moreGrid"></div>

        <!-- データ管理（CSVエクスポート/インポート） -->
        <div class="moreTools">
          <button class="btn" type="button" onclick="exportCSV()">エクスポート</button>

          <input id="importCsvInput" type="file" accept=".csv,text/csv" style="display:none" onchange="importCSVReplace(this)">
          <button class="btn" type="button" onclick="document.getElementById('importCsvInput').click()">インポート</button>
        </div>
      </div>
    </div>

    <div class="seg viewSeg" id="viewSeg">
      <button class="active" data-view="trend">Trend</button>
      <button data-view="bodymap">BodyMap</button>
      <button data-view="more">More</button>
    </div>
  </div>

  <div class="safeBottom"></div>
</div>

<!-- Targets Modal -->
<div class="modalBg" id="modalTargetsBg">
  <div class="modal">
    <div class="mTitle">目標値（保存されます）</div>
    <div class="form">
      <div class="field">
        <label>体重 目標 (kg)</label>
        <input id="t_weight" type="number" step="0.1" inputmode="decimal" />
      </div>
      <div class="field">
        <label>体脂肪率 目標 (%)</label>
        <input id="t_bf" type="number" step="0.1" inputmode="decimal" />
      </div>
      <div class="field">
        <label>筋肉量 目標 (kg)</label>
        <input id="t_muscle" type="number" step="0.1" inputmode="decimal" />
      </div>
      <div class="field">
        <label>体脂肪量 目標 (kg)</label>
        <input id="t_fat" type="number" step="0.1" inputmode="decimal" />
      </div>
    </div>
    <div class="modalActions">
      <button class="btn" type="button" onclick="closeTargets()">キャンセル</button>
      <button class="btn btnPrimary" type="button" onclick="saveTargets()">保存</button>
    </div>
  </div>
</div>

<!-- Add/Edit Modal -->
<div class="modalBg" id="modalAddBg">
  <div class="modal">
    <div class="mTitle" id="addTitle">データ追加（保存されます）</div>
    <div class="form">
      <div class="field">
        <label>日付 (YYYY-MM-DD)</label>
        <input id="a_date" type="text" placeholder="2025-12-25" />
      </div>
      <div class="field">
        <label>体重 (kg)</label>
        <input id="a_weight" type="number" step="0.1" inputmode="decimal" />
      </div>
      <div class="field">
        <label>体脂肪率 (%)</label>
        <input id="a_bf" type="number" step="0.1" inputmode="decimal" />
      </div>
      <div class="field">
        <label>筋肉量 (kg)</label>
        <input id="a_muscle" type="number" step="0.1" inputmode="decimal" />
      </div>
      <div class="field">
        <label>骨格筋量 (kg)</label>
        <input id="a_smm" type="number" step="0.1" inputmode="decimal" />
      </div>
      <div class="field">
        <label>内臓脂肪 (lv)</label>
        <input id="a_vf" type="number" step="0.1" inputmode="decimal" />
      </div>
    </div>
    <div class="modalActions">
      <button class="btn" type="button" onclick="closeAdd()">キャンセル</button>
      <button class="btn btnDanger" type="button" onclick="deleteCurrent()">削除</button>
      <button class="btn btnPrimary" type="button" onclick="saveAdd()">保存</button>
    </div>
  </div>
</div>

<script>
  // ===== Base CSV =====
  const BASE_CSV = `date,weight_kg,bodyfat_pct,bmi,fitness_score,fatmass_kg,muscle_kg,skeletal_muscle_kg,visceral_fat_level
2024-07-25,91.2,33,28.1,58,30.1,58.5,27.8,14
2024-08-01,90.0,32.5,27.8,60,29.3,58.8,28.0,13
2024-08-08,89.0,32.0,27.5,61,28.5,59.0,28.1,13
2024-08-15,87.8,31.4,27.2,63,27.6,59.4,28.3,12
2024-08-22,86.5,30.8,26.9,65,26.6,59.7,28.5,12
2024-08-29,86.2,30.5,26.8,66,26.3,59.8,28.6,12
2024-09-05,85.0,30.0,26.4,67,25.5,60.0,28.7,11
2024-09-12,84.2,29.6,26.2,68,24.9,60.1,28.8,11
2024-09-19,83.5,29.2,26.0,69,24.4,60.2,28.9,11
2024-09-26,82.8,28.8,25.8,70,23.8,60.3,29.0,10
2024-10-03,82.2,28.4,25.6,71,23.4,60.4,29.1,10
2024-10-10,81.8,28.2,25.5,72,23.1,60.5,29.2,10
2024-10-17,81.5,28.0,25.4,72,22.8,60.6,29.3,10
2024-10-24,81.2,27.8,25.3,73,22.6,60.7,29.4,10
2024-10-31,80.8,27.6,25.2,74,22.3,60.8,29.5,10
2024-11-07,80.5,27.4,25.1,74,22.1,60.9,29.6,10
2024-11-14,80.2,27.2,25.0,75,21.9,61.0,29.7,10
2024-11-21,80.0,27.1,24.9,75,21.7,61.1,29.8,10
2024-11-28,79.8,27.0,24.8,76,21.5,61.2,29.9,10
2024-12-05,79.5,26.8,24.7,76,21.3,61.3,30.0,10
2024-12-12,79.2,26.6,24.6,77,21.0,61.4,30.1,9.8
2024-12-19,79.0,26.5,24.5,77,20.9,61.5,30.2,9.6
2024-12-26,78.7,26.3,24.4,78,20.7,61.6,30.3,9.4
2025-01-02,78.4,26.1,24.3,78,20.5,61.7,30.4,9.2
2025-01-09,78.1,25.9,24.2,79,20.2,61.8,30.5,9.0
2025-01-16,77.8,25.7,24.1,79,20.0,61.9,30.6,8.8
2025-01-23,77.5,25.5,24.0,80,19.8,62.0,30.7,8.6
2025-01-30,77.2,25.3,23.9,80,19.5,62.1,30.8,8.4
2025-02-06,76.8,25.1,23.8,81,19.3,62.2,30.9,8.2
2025-02-13,76.5,24.9,23.7,81,19.1,62.3,31.0,8.0
2025-02-20,76.2,24.7,23.6,82,18.8,62.4,31.1,7.8
2025-02-27,75.8,24.5,23.5,82,18.6,62.5,31.2,7.6
2025-03-06,75.5,24.3,23.4,83,18.4,62.6,31.3,7.4
2025-03-13,75.2,24.1,23.3,83,18.1,62.7,31.4,7.2
2025-03-20,74.8,23.9,23.2,84,17.9,62.8,31.5,7.0
2025-03-27,74.5,23.7,23.1,84,17.7,62.9,31.6,6.8
2025-04-03,74.2,23.5,23.0,85,17.4,63.0,31.7,6.6
2025-04-10,73.8,23.3,22.9,85,17.2,63.1,31.8,6.4
2025-04-17,73.5,23.1,22.8,86,17.0,63.2,31.9,6.2
2025-04-24,73.2,22.9,22.7,86,16.7,63.3,32.0,6.0
2025-05-01,72.8,22.7,22.6,87,16.5,63.4,32.1,5.8
2025-05-08,72.5,22.5,22.5,87,16.3,63.5,32.2,5.6
2025-05-15,72.2,22.3,22.4,88,16.0,63.6,32.3,5.4
2025-05-22,71.9,22.2,22.3,88,15.9,63.7,32.4,5.2
2025-05-29,71.7,22.2,22.3,88,15.9,63.7,32.4,5.2`;

  const TARGET_KEY  = "progressfit_targets_v2";
  const ADDS_KEY    = "progressfit_added_rows_v1";
  const DELETED_KEY = "progressfit_deleted_dates_v1";

  function parseCsv(csv){
    const lines = csv.trim().split(/\r?\n/);
    const header = lines.shift().split(",");
    return lines
      .filter(l=>l.trim().length)
      .map(l=>{
        const cols = l.split(",");
        const o = {};
        header.forEach((h,i)=> o[h] = cols[i]);
        // numbers
        o.weight_kg = +o.weight_kg;
        o.bodyfat_pct = +o.bodyfat_pct;
        o.bmi = +o.bmi;
        o.fitness_score = +o.fitness_score;
        o.fatmass_kg = +o.fatmass_kg;
        o.muscle_kg = +o.muscle_kg;
        o.skeletal_muscle_kg = +o.skeletal_muscle_kg;
        o.visceral_fat_level = +o.visceral_fat_level;
        return o;
      });
  }

  const baseRows = parseCsv(BASE_CSV);

  function loadTargets(){
    try{return JSON.parse(localStorage.getItem(TARGET_KEY) || "null");}catch(e){return null;}
  }
  function saveTargetsToStorage(obj){
    localStorage.setItem(TARGET_KEY, JSON.stringify(obj));
  }

  function loadAdds(){
    try{return JSON.parse(localStorage.getItem(ADDS_KEY) || "[]");}catch(e){return [];}
  }
  function saveAdds(arr){
    localStorage.setItem(ADDS_KEY, JSON.stringify(arr));
  }

  function loadDeleted(){
    try{return JSON.parse(localStorage.getItem(DELETED_KEY) || "[]");}catch(e){return [];}
  }
  function saveDeleted(arr){
    localStorage.setItem(DELETED_KEY, JSON.stringify(arr));
  }

  function mergeRows(){
    const adds = loadAdds();
    const deleted = new Set(loadDeleted());
    const map = new Map();

    for(const r of baseRows){
      if(!deleted.has(r.date)) map.set(r.date, {...r});
    }
    for(const r of adds){
      if(!deleted.has(r.date)) map.set(r.date, {...r});
    }

    const rows = Array.from(map.values()).sort((a,b)=>a.date.localeCompare(b.date));
    return rows;
  }

  let rows = mergeRows();

  // ===== UI helpers =====
  function fmt1(x){return (Math.round(x*10)/10).toFixed(1);}
  function fmt0(x){return String(Math.round(x));}

  function dateRangeLabel(arr){
    if(!arr.length) return "—";
    return `${arr[0].date} → ${arr[arr.length-1].date}`;
  }

  function getPeriodFiltered(arr, period){
    if(period==="all") return arr;
    if(!arr.length) return arr;

    const last = arr[arr.length-1].date;
    const [y,m,d] = last.split("-").map(Number);
    const lastDate = new Date(y, m-1, d);

    let days = 99999;
    if(period==="1y") days = 365;
    if(period==="3m") days = 92;

    const from = new Date(lastDate);
    from.setDate(from.getDate()-days);

    return arr.filter(r=>{
      const [yy,mm,dd] = r.date.split("-").map(Number);
      const dt = new Date(yy,mm-1,dd);
      return dt >= from;
    });
  }

  // ===== Cards render =====
  function renderTopCards(arr, targets){
    const top = document.getElementById("topCards");
    top.innerHTML = "";
    if(!arr.length) return;

    const first = arr[0];
    const last  = arr[arr.length-1];

    const metrics = [
      {k:"weight_kg",   name:"体重",     unit:"kg", goodDir:-1},
      {k:"bodyfat_pct", name:"体脂肪率", unit:"%",  goodDir:-1},
      {k:"fatmass_kg",  name:"体脂肪量", unit:"kg", goodDir:-1},
      {k:"muscle_kg",   name:"筋肉量",   unit:"kg", goodDir:+1},
    ];

    metrics.forEach(m=>{
      const delta = (last[m.k] - first[m.k]);
      const isGood = (m.goodDir===-1) ? (delta<=0) : (delta>=0);
      const sign = delta>=0 ? "+" : "";
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div class="cardTop">
          <div class="label">${m.name}</div>
          <div class="delta ${isGood?'good':'bad'}">${sign}${fmt1(delta)}</div>
        </div>
        <div class="big">
          <div>${fmt1(last[m.k])}</div>
          <div class="unit">${m.unit}</div>
        </div>
      `;
      top.appendChild(card);
    });
  }

  function renderMidCards(arr){
    const mid = document.getElementById("midCards");
    mid.innerHTML = "";
    if(!arr.length) return;

    const last = arr[arr.length-1];

    const cards = [
      {name:"フィットネススコア", val:last.fitness_score, unit:"pt"},
      {name:"BMI", val:last.bmi, unit:""},
      {name:"骨格筋量", val:last.skeletal_muscle_kg, unit:"kg"},
      {name:"内臓脂肪", val:last.visceral_fat_level, unit:"lv"},
    ];

    cards.forEach(c=>{
      const el = document.createElement("div");
      el.className="card";
      el.innerHTML = `
        <div class="label">${c.name}</div>
        <div class="smallVal">
          <div>${(c.unit===""? fmt1(c.val): fmt1(c.val))}</div>
          <div class="smallUnit">${c.unit}</div>
        </div>
      `;
      mid.appendChild(el);
    });
  }

  // ===== Chart =====
  let chart;
  let currentMetric = "weight_kg";
  const metricInfo = {
    weight_kg:   {label:"体重", unit:"kg", targetKey:"weight"},
    bodyfat_pct: {label:"体脂肪率", unit:"%", targetKey:"bf"},
    fatmass_kg:  {label:"体脂肪量", unit:"kg", targetKey:"fat"},
    muscle_kg:   {label:"筋肉量", unit:"kg", targetKey:"muscle"},
  };

  function ensureChart(){
    const ctx = document.getElementById("chart");
    if(chart) return;
    chart = new Chart(ctx, {
      type:"line",
      data:{labels:[], datasets:[]},
      options:{
        responsive:true,
        maintainAspectRatio:false,
        interaction:{mode:"index", intersect:false},
        plugins:{legend:{display:false}},
        scales:{
          x:{grid:{color:"rgba(255,255,255,.06)"}, ticks:{color:"rgba(232,238,247,.55)"}},
          y:{grid:{color:"rgba(255,255,255,.06)"}, ticks:{color:"rgba(232,238,247,.55)"}}
        }
      }
    });
  }

  function renderChart(arr, targets){
    ensureChart();
    const info = metricInfo[currentMetric];

    const labels = arr.map(r=>r.date);
    const values = arr.map(r=>r[currentMetric]);

    const datasets = [{
      label: info.label,
      data: values,
      borderColor: "rgba(106,216,255,.9)",
      backgroundColor: "rgba(106,216,255,.2)",
      pointRadius: 2,
      borderWidth: 2,
      tension: .25
    }];

    const tKey = info.targetKey;
    const targetVal = targets && targets[tKey]!=null ? +targets[tKey] : null;
    if(targetVal!=null && !Number.isNaN(targetVal)){
      datasets.push({
        label: "TARGET",
        data: labels.map(()=>targetVal),
        borderColor: "rgba(62,234,134,.85)",
        borderDash: [6,6],
        pointRadius: 0,
        borderWidth: 2
      });
    }

    chart.data.labels = labels;
    chart.data.datasets = datasets;
    chart.update();
  }

  // ===== More view =====
  function renderMore(arr){
    const g = document.getElementById("moreGrid");
    g.innerHTML = "";
    if(!arr.length) return;

    const last = arr[arr.length-1];
    const items = [
      {t:"最新 体重", v: fmt1(last.weight_kg), u:"kg"},
      {t:"最新 体脂肪率", v: fmt1(last.bodyfat_pct), u:"%"},
      {t:"最新 筋肉量", v: fmt1(last.muscle_kg), u:"kg"},
      {t:"最新 体脂肪量", v: fmt1(last.fatmass_kg), u:"kg"},
    ];

    items.forEach(it=>{
      const c = document.createElement("div");
      c.className="mCard";
      c.innerHTML = `<div class="mTitle">${it.t}</div>
                     <div class="mVal">${it.v}<span class="mUnit">${it.u}</span></div>`;
      g.appendChild(c);
    });
  }

  // ===== Render all =====
  let period = "all";
  function render(){
    const targets = loadTargets();
    const all = mergeRows();
    rows = getPeriodFiltered(all, period);

    document.getElementById("rangeLabel").textContent = dateRangeLabel(all);
    document.getElementById("countChip").textContent = `件数 ${all.length}`;

    renderTopCards(rows, targets);
    renderMidCards(rows);
    renderChart(rows, targets);
    renderMore(all);
  }

  // ===== Period segment =====
  document.getElementById("periodSeg").addEventListener("click", (e)=>{
    if(e.target.tagName!=="BUTTON") return;
    [...document.querySelectorAll("#periodSeg button")].forEach(b=>b.classList.remove("active"));
    e.target.classList.add("active");
    period = e.target.dataset.period;
    render();
  });

  // ===== Metric tabs =====
  document.getElementById("metricTabs").addEventListener("click", (e)=>{
    const el = e.target.closest(".tab");
    if(!el) return;
    [...document.querySelectorAll(".tab")].forEach(t=>t.classList.remove("active"));
    el.classList.add("active");
    currentMetric = el.dataset.metric;
    render();
  });

  // ===== View switch =====
  function setView(v){
    const trend = document.getElementById("trendView");
    const body  = document.getElementById("bodyMapView");
    const more  = document.getElementById("moreView");

    trend.style.display = (v==="trend") ? "" : "none";
    body.style.display  = (v==="bodymap") ? "" : "none";
    more.style.display  = (v==="more") ? "" : "none";

    [...document.querySelectorAll("#viewSeg button")].forEach(b=>b.classList.remove("active"));
    document.querySelector(`#viewSeg button[data-view="${v}"]`).classList.add("active");
  }

  document.getElementById("viewSeg").addEventListener("click", (e)=>{
    if(e.target.tagName!=="BUTTON") return;
    setView(e.target.dataset.view);
  });

  // ===== Targets modal =====
  function openTargets(){
    const bg = document.getElementById("modalTargetsBg");
    const t = loadTargets() || {};
    document.getElementById("t_weight").value = t.weight ?? "";
    document.getElementById("t_bf").value = t.bf ?? "";
    document.getElementById("t_muscle").value = t.muscle ?? "";
    document.getElementById("t_fat").value = t.fat ?? "";
    bg.style.display="flex";
  }
  function closeTargets(){ document.getElementById("modalTargetsBg").style.display="none"; }
  function saveTargets(){
    const obj = {
      weight: document.getElementById("t_weight").value==="" ? null : +document.getElementById("t_weight").value,
      bf:     document.getElementById("t_bf").value==="" ? null : +document.getElementById("t_bf").value,
      muscle: document.getElementById("t_muscle").value==="" ? null : +document.getElementById("t_muscle").value,
      fat:    document.getElementById("t_fat").value==="" ? null : +document.getElementById("t_fat").value,
    };
    saveTargetsToStorage(obj);
    closeTargets();
    render();
  }

  // ===== Add/Edit modal =====
  let editingDate = null;

  function openAdd(){
    editingDate = null;
    document.getElementById("addTitle").textContent = "データ追加（保存されます）";
    document.getElementById("a_date").value = "";
    document.getElementById("a_weight").value = "";
    document.getElementById("a_bf").value = "";
    document.getElementById("a_muscle").value = "";
    document.getElementById("a_smm").value = "";
    document.getElementById("a_vf").value = "";
    document.getElementById("modalAddBg").style.display="flex";
  }
  function closeAdd(){ document.getElementById("modalAddBg").style.display="none"; }

  function saveAdd(){
    const date = document.getElementById("a_date").value.trim();
    if(!/^\d{4}-\d{2}-\d{2}$/.test(date)) return alert("日付はYYYY-MM-DDで");

    const row = {
      date,
      weight_kg: +document.getElementById("a_weight").value || 0,
      bodyfat_pct: +document.getElementById("a_bf").value || 0,
      bmi: 0,
      fitness_score: 0,
      fatmass_kg: 0,
      muscle_kg: +document.getElementById("a_muscle").value || 0,
      skeletal_muscle_kg: +document.getElementById("a_smm").value || 0,
      visceral_fat_level: +document.getElementById("a_vf").value || 0
    };

    // simple derived
    if(row.weight_kg>0){
      const heightM = 1.75; // 仮
      row.bmi = row.weight_kg/(heightM*heightM);
    }
    row.fatmass_kg = row.weight_kg * (row.bodyfat_pct/100);
    row.fitness_score = Math.max(0, Math.min(100, 100 - row.bodyfat_pct*1.2));

    const adds = loadAdds().filter(r=>r.date!==date);
    adds.push(row);
    saveAdds(adds);

    // remove deletion mark if exists
    const del = loadDeleted().filter(d=>d!==date);
    saveDeleted(del);

    closeAdd();
    render();
  }

  function deleteCurrent(){
    const date = document.getElementById("a_date").value.trim();
    if(!/^\d{4}-\d{2}-\d{2}$/.test(date)) return alert("日付が不正");

    if(!confirm(`${date} を削除する？`)) return;
    const del = new Set(loadDeleted());
    del.add(date);
    saveDeleted(Array.from(del));

    // also remove from adds list
    const adds = loadAdds().filter(r=>r.date!==date);
    saveAdds(adds);

    closeAdd();
    render();
  }

  // chips actions
  document.getElementById("targetChip").addEventListener("click", openTargets);
  document.getElementById("addChip").addEventListener("click", openAdd);

  // close modals on backdrop
  document.getElementById("modalTargetsBg").addEventListener("click", (e)=>{ if(e.target.id==="modalTargetsBg") closeTargets(); });
  document.getElementById("modalAddBg").addEventListener("click", (e)=>{ if(e.target.id==="modalAddBg") closeAdd(); });

  // ===== CSV Export / Import (Full replace) =====
  function exportCSV(){
    const data = mergeRows();
    if(!data.length) return alert('データがありません');

    const headers = [
      'date','weight_kg','bodyfat_pct','bmi','fitness_score',
      'fatmass_kg','muscle_kg','skeletal_muscle_kg','visceral_fat_level'
    ];

    const v = (x)=> (x===null || x===undefined || Number.isNaN(x)) ? '' : String(x);
    const rowsCsv = data.map(r => headers.map(h => v(r[h])).join(','));
    const csv = [headers.join(','), ...rowsCsv].join('\n');

    const blob = new Blob([csv], { type:'text/csv;charset=utf-8' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = `progressfit_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();

    URL.revokeObjectURL(url);
  }

  function importCSVReplace(input){
    const file = input.files?.[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const text = String(reader.result || '').trim();
        if(!text) return alert('CSVが空です');

        if(!confirm('現在のデータを全置換してインポートする？')) return;

        const imported = parseCsv(text);
        if(!Array.isArray(imported) || !imported.length) return alert('CSVの形式が違うっぽい');

        const importedDates = new Set(imported.map(r=>r.date));
        const deleted = baseRows
          .filter(r => !importedDates.has(r.date))
          .map(r => r.date);

        saveAdds(imported);
        saveDeleted(deleted);

        rows = mergeRows();
        alert('インポート完了');
        render();
      }catch(e){
        alert('CSVの読み込みに失敗した（形式を確認してね）');
      }finally{
        input.value = '';
      }
    };
    reader.readAsText(file, 'utf-8');
  }

  // init
  setView("trend");
  render();
</script>
</body>
</html>